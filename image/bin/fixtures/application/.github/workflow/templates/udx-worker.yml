name: UDX Worker

on:
  workflow_call:
    inputs:
      command:
        required: true
        type: string
      image:
        required: false
        type: string
        default: "udx-worker:latest"
      volumes:
        required: false
        type: string
        default: '["/path/to/volume1", "/path/to/volume2"]' # replace with your actual volumes

jobs:
  udx-worker:
    runs-on: ubuntu-latest
    container:
      image: ${{ inputs.image }}
      volumes: ${{ fromJSON(inputs.volumes) }}

    env:
      DEFAULT_IMAGES: '["udx-worker"]'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check for non-default worker
        run: |
          if ! echo '${{ fromJSON(env.DEFAULT_IMAGES) }}' | grep -q "${{ inputs.image }}"; then
            echo "Warning: Using a non-default udx-worker may cause compatibility issues."
          else
            echo "Using the default udx-worker."

            if [[ "${{ inputs.image }}" != *":latest" ]]; then
              echo "Warning: Using a non-latest version of the udx-worker is not recommended."
            fi
          fi

      - name: Check for missing volumes
        run: |
          if [[ -z "${{ inputs.volumes }}" ]]; then
            echo "Warning: No volumes specified. Consider adding volumes for your use case."
          fi

      - name: UDX Worker CLI
        run: |
          if ! udx-worker --version; then
            npm install @udx/worker --saveDev 
          fi

      - name: Run udx-worker command
        run: udx-worker --image=${{ inputs.image }} --command=${{ inputs.command }}